<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Promise</title>
</head>
<body>
<script>
    // Промисифицировать setTimeout
    /*
     function delay(ms) {

        return  new Promise((resolve, reject) => {
            setTimeout( resolve, ms);
        });
    }

    delay(10000)
            .then(() => alert("Hello!"));
    */ //(+-)
    /*
    function delay(ms) {

        return new Promise((resolve, reject) => {
            setTimeout(resolve, ms);
        });
    }

    delay(5000).
        then(() => alert("Hello!"));
    */ //(+)
    /*
    function delay (ms)  {
        return new Promise((resolve, reject) => {
            setTimeout( resolve, ms );
        });
    }

    delay(1000)
        .then(() => alert("Hello!"));
    */ //(+)

    // Загрузить массив последовательно
    /*
    function httpGet(url) {
        return "куку";
    }

    let urls = [
        "user.json",
        "guest.json"
    ];

    var chain = Promise.resolve();

    var results = [];

    urls.forEach( function (url) {
        chain = chain
            .then(function () {
                return httpGet(url);
            })
            .then( function (result) {
                return results.push(result);
            });
    });

    chain.then( function () {
        return alert(results);
    });
    */ //(-)
    /*
    function httpGet() {
        return "getHttp";
    }

    let urls = [
        "user.json",
        "guest.json"
    ];

    let results = [];

    let chain = Promise.resolve();

    urls.forEach( function (url) {
        chain = chain
            .then(() => httpGet(url))
            .then((result) => {
                results.push(result);
            });
    });

    chain.then(() => {
        alert(results);
    });
    */ //(-)
    /*
    let httpGet = () => "ку";

    let urls = [
        "user.json",
        "guest.json"
    ];

    let results = [];
    let chain = Promise.resolve();

    urls.forEach(function (url) {
        chain = chain
            .then(() => httpGet(url))
            .then((result) => {
                results.push(result);
            });
    });

    chain
        .then(() => {
            alert(results);
        })
    */ //(-)


    var PENDING = 0;
    var FULFILLED = 1;
    var REJECTED = 2;

    function Promisee(fn) {
        if (typeof this !== 'object')
            throw new TypeError('Promises must be constructed via new');
        if (typeof fn !== 'function')
            throw new TypeError('fn must be a function');

        // store state which can be PENDING, FULFILLED or REJECTED
        var state = PENDING;

        // store value once FULFILLED or REJECTED
        var value = null;

        // store sucess & failure handlers
        var handlers = [];

        function doResolve(fn, onFulfilled, onRejected) {
            var done = false;
            try {
                fn(function (value) {
                    if (done) return;
                    done = true;
                    onFulfilled(value)
                }, function (reason) {
                    if (done) return;
                    done = true;
                    onRejected(reason)
                })
            } catch (ex) {
                if (done) return;
                done = true;
                onRejected(ex)
            }
        }


        function resolve(result) {

            function getThen(value) {
                if (result && (typeof result === 'object' || typeof result === 'function')) {
                    var then = value.then;
                    if (typeof then === 'function') {
                        return then;
                    }
                }
                return null;
            }

            try {
                var then = getThen(result);
                if (then) {
                    doResolve(then.bind(result), resolve, reject);
                    return;
                }
                state = FULFILLED;
                value = result;
                handlers.forEach(handle);
                handlers = null;
            } catch (e) {
                reject(e);
            }
        }



        function reject(error) {
            state = REJECTED;
            value = error;
            handlers.forEach(handle);
            handlers = null;
        }

        function handle(handler) {
            if (state === PENDING) {
                handlers.push(handler);
            } else {
                if (state === FULFILLED && typeof handler.onFulfilled === 'function') {
                    handler.onFulfilled(value);
                }
                if (state === REJECTED && typeof handler.onRejected === 'function') {
                    handler.onRejected(value);
                }
            }
        }
        this.done = function (onFulfilled, onRejected) {
            setTimeout(function () { // ensure we are always asynchronous
                handle({
                    onFulfilled: onFulfilled,
                    onRejected: onRejected
                });
            }, 0);
        };

        doResolve(fn, resolve, reject);


        this.then = function (onFulfilled, onRejected) {
            var self = this;
            return new Promise(function (resolve, reject) {
                return self.done(function (result) {
                    if (typeof onFulfilled === 'function') {
                        try {
                            return resolve(onFulfilled(result));
                        } catch (ex) {
                            return reject(ex);
                        }
                    } else {
                        return resolve(result);
                    }
                }, function (error) {
                    if (typeof onRejected === 'function') {
                        try {
                            return resolve(onRejected(error));
                        } catch (ex) {
                            return reject(ex);
                        }
                    } else {
                        return reject(error);
                    }
                });
            });
        };
    }



    function delay(ms) {

        return new Promisee(function (resolve, reject) {
            return setTimeout( resolve, ms);
        });
    }
    delay(3000).then(function () {
        return console.log("Работает!");
    });


</script>
</body>
</html>